<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Viewer with Telestration</title>
    <script src="https://public.flourish.studio/resources/embed.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Media Viewer Styles */
        body {
            background-size: cover;
            background-position: center;
            transition: background 0s ease-in-out;
            margin: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chart {
            display: none;
            position: fixed;
            top: 22%;
            left: 18vw;
            width: 65vw;
            height: 40vh;
            z-index: 2;
        }
        .video-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .button-container {
            position: absolute;
            right: 70px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }
        button {
            padding: 1px 2px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: white;
            border-radius: 5px;
            transition: background 0.3s, transform 0.2s ease-in-out;
        }
        button:hover {
            background-color: rgba(0, 0, 0, 0.1);
            transform: scale(1.05);
        }
        /* Telestration Panel CSS */
        .telestration-panel {
            position: fixed;
            top: 10%;
            right: 10px;
            width: 50px;
            height: 80vh;
            background-color: rgba(0, 0, 0, 0);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 5px 0;
            z-index: 1100;
        }
        .telestration-panel h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: #b0b0b0;
            margin: 0 0 8px;
            border-bottom: 1px solid #4a4e54;
            padding-bottom: 5px;
        }
        .telestration-tools,
        .telestration-colors,
        .telestration-weights,
        .telestration-shapes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 8px;
        }
        .telestration-tool-btn,
        .telestration-color-btn,
        .telestration-weight-btn,
        .telestration-shape-btn {
            background-color: rgba(0, 0, 0, 0.1);
            color: #c0c0c0;
            border: none;
            border-radius: 4px;
            padding: 6px;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.8rem;
        }
        .telestration-tool-btn:hover,
        .telestration-color-btn:hover,
        .telestration-weight-btn:hover,
        .telestration-shape-btn:hover {
            background-color: #4a4e54;
        }
        .telestration-tool-btn.active,
        .telestration-color-btn.active,
        .telestration-weight-btn.active,
        .telestration-shape-btn.active {
            background-color: rgba(202, 255, 164, 0.5);
            color: white;
            border-color: #c53030;
        }
        .telestration-color-btn {
            width: 20px;
            height: 20px;
            padding: 0;
        }
        #clear-canvas-btn {
            background-color: rgba(0, 0, 0, 0.1);
            color: rgba(255, 255, 255, 0.5);
            border: none;
            border-radius: 4px;
            padding: 0;
            height: 20px;
            width: 20px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #clear-canvas-btn i {
            font-size: 12px; /* Smaller icon */
        }

        #telestration-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 950;
            pointer-events: none;
        }
        #telestration-canvas.active-drawing {
            pointer-events: auto;
        }
        .telestration-color-btn[data-color="#FF0000"] i {
            color: rgba(255, 0, 0, 0.5);
        }
        .telestration-color-btn[data-color="#00FF00"] i {
            color: rgba(0, 255, 0, 0.5);
        }
        .telestration-color-btn[data-color="#000000"] i {
            color: rgba(0, 0, 0, 0.5);
    </style>
</head>
<body>
    <div class="container"><div id="video1" class="media video-container" style="display:none;"><video autoplay muted onended><source src="media/topslide.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
    <div id="video2" class="media video-container" style="display:none;"><video autoplay muted onended><source src="media/costs.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
    <div id="flourish3" class="media chart" style="display:none;"><div class="flourish-embed flourish-chart" data-src="visualisation/23138752"></div></div>
    <div id="video4" class="media video-container" style="display:none;"><video autoplay muted onended><source src="media/comparison2.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
    <div id="video5" class="media video-container" style="display:none;"><video autoplay muted onended><source src="media/comparison1.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
    <div id="video6" class="media video-container" style="display:none;"><video autoplay muted onended><source src="media/quote.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
    <div id="flourish7" class="media chart" style="display:none;"><div class="flourish-embed flourish-chart" data-src="visualisation/23139853"></div></div>
    <div id="video8" class="media video-container" style="display:none;"><video autoplay muted onended><source src="media/z_placeholder.mp4" type="video/mp4">Your browser does not support the video tag.</video></div>
    </div>
    <div class="button-container">
        <button id="nextBtn" onclick="changeMedia(1)">→</button>
        <button id="backBtn" onclick="changeMedia(-1)">←</button>
    </div>
    <!-- Sleek Telestration Panel -->
    <div class="telestration-panel">
        <button id="cursor-tool" class="telestration-tool-btn" title="Cursor"><i class="fas fa-mouse-pointer"></i></button>
        <button id="pen-tool" class="telestration-tool-btn active" title="Pen"><i class="fas fa-pencil-alt"></i></button>
        <button class="telestration-shape-btn" data-shape="line" title="Line"><i class="fas fa-minus"></i></button>
        <button class="telestration-shape-btn" data-shape="arrow" title="Arrow"><i class="fas fa-long-arrow-alt-right"></i></button>
        <button class="telestration-shape-btn" data-shape="rectangle" title="Rectangle"><i class="far fa-square"></i></button>
        <button class="telestration-shape-btn" data-shape="circle" title="Circle"><i class="far fa-circle"></i></button>
        <button class="telestration-color-btn active" data-color="#FF0000" title="Red"><i class="fas fa-circle"></i></button>
        <button class="telestration-color-btn" data-color="#00FF00" title="Yellow"><i class="fas fa-circle"></i></button>
        <button class="telestration-color-btn" data-color="#000000" title="White"><i class="fas fa-circle"></i></button>
        <button class="telestration-weight-btn active" data-weight="2" title="Small">S</button>
        <button class="telestration-weight-btn" data-weight="5" title="Medium">M</button>
        <button class="telestration-weight-btn" data-weight="10" title="Large">L</button>
        <button id="clear-canvas-btn" title="Clear"><i class="fas fa-trash"></i></button>
    </div>
    <canvas id="telestration-canvas"></canvas>
    <script>
        // Media Viewer Script
        var currentIndex = 0;
        var mediaElements = document.querySelectorAll('.media');
        var backgrounds = [
        '',
        '',
        'media/prices.png',
        '',
        '',
        '',
        'media/generic.png',
        ''];
        function showMedia(index) {
            mediaElements.forEach(el => {
                el.style.display = 'none';
                var vid = el.querySelector('video');
                if (vid) { vid.pause(); vid.currentTime = 0; }
            });
            var active = mediaElements[index];
            active.style.display = 'block';
            document.body.style.backgroundImage = `url('${backgrounds[index]}')`;
            var vid2 = active.querySelector('video');
            if (vid2) vid2.play();
        }
        function changeMedia(dir) {
            clearTelestration();
            currentIndex = (currentIndex + dir + mediaElements.length) % mediaElements.length;
            showMedia(currentIndex);
        }
        showMedia(currentIndex);

        // Telestration Logic
        const canvasEl = document.getElementById('telestration-canvas');
        const ctx = canvasEl.getContext('2d');
        const penToolBtnEl = document.getElementById('pen-tool');
        const cursorToolBtnEl = document.getElementById('cursor-tool');
        const colorBtnsEl = document.querySelectorAll('.telestration-color-btn');
        const weightBtnsEl = document.querySelectorAll('.telestration-weight-btn');
        const shapeBtnsEl = document.querySelectorAll('.telestration-shape-btn');
        const clearCanvasBtnEl = document.getElementById('clear-canvas-btn');
        let currentTool = 'pen', strokeColor = '#FF0000', lineWidth = 2;
        let shapeStartX, shapeStartY, isPenDrawing = false, penLastX, penLastY, penInitialX, penInitialY;

        function resizeCanvas() {
            canvasEl.width = window.innerWidth;
            canvasEl.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function updateActiveBtn(selector, clicked) {
            document.querySelectorAll(selector).forEach(btn => btn.classList.remove('active'));
            if (clicked) clicked.classList.add('active');
        }

        penToolBtnEl.addEventListener('click', () => {
            currentTool = 'pen';
            updateActiveBtn('.telestration-tool-btn', penToolBtnEl);
            updateActiveBtn('.telestration-shape-btn', null);
            canvasEl.classList.add('active-drawing');
        });
        cursorToolBtnEl.addEventListener('click', () => {
            currentTool = 'cursor';
            updateActiveBtn('.telestration-tool-btn', cursorToolBtnEl);
            updateActiveBtn('.telestration-shape-btn', null);
            canvasEl.classList.remove('active-drawing');
        });

        colorBtnsEl.forEach(btn => btn.addEventListener('click', () => {
            strokeColor = btn.dataset.color;
            updateActiveBtn('.telestration-color-btn', btn);
        }));
        weightBtnsEl.forEach(btn => btn.addEventListener('click', () => {
            lineWidth = parseInt(btn.dataset.weight, 10);
            updateActiveBtn('.telestration-weight-btn', btn);
        }));
        shapeBtnsEl.forEach(btn => btn.addEventListener('click', () => {
            currentTool = btn.dataset.shape;
            updateActiveBtn('.telestration-shape-btn', btn);
            updateActiveBtn('.telestration-tool-btn', null);
            canvasEl.classList.add('active-drawing');
        }));

        clearCanvasBtnEl.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        });

        function clearTelestration() {
            ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        }


        canvasEl.addEventListener('mousedown', e => {
            if (!canvasEl.classList.contains('active-drawing')) return;
            const rect = canvasEl.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (currentTool === 'pen') {
                isPenDrawing = true;
                penInitialX = penLastX = x;
                penInitialY = penLastY = y;
                ctx.beginPath(); ctx.moveTo(penLastX, penLastY);
            } else {
                shapeStartX = x; shapeStartY = y;
            }
        });

        canvasEl.addEventListener('mousemove', e => {
            if (!canvasEl.classList.contains('active-drawing')) return;
            const rect = canvasEl.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            if (currentTool === 'pen' && isPenDrawing) {
                const midX = (penLastX + x) / 2;
                const midY = (penLastY + y) / 2;
                ctx.quadraticCurveTo(penLastX, penLastY, midX, midY);
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = lineWidth;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                penLastX = x; penLastY = y;
                ctx.beginPath(); ctx.moveTo(midX, midY);
            }
        });

        canvasEl.addEventListener('mouseup', e => {
            if (!canvasEl.classList.contains('active-drawing')) return;
            const rect = canvasEl.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if (currentTool === 'pen') {
                if (!isPenDrawing) return;
                isPenDrawing = false;
                if (penInitialX === x && penInitialY === y) {
                    ctx.fillStyle = strokeColor;
                    ctx.beginPath();
                    ctx.arc(penInitialX, penInitialY, lineWidth/2, 0, 2*Math.PI);
                    ctx.fill();
                } else {
                    ctx.lineTo(x, y); ctx.stroke();
                }
            } else if (currentTool === 'line') {
                ctx.beginPath(); ctx.moveTo(shapeStartX, shapeStartY);
                ctx.lineTo(x, y); ctx.stroke();
            } else if (currentTool === 'arrow') {
                drawArrow(shapeStartX, shapeStartY, x, y);
            } else if (currentTool === 'rectangle') {
                ctx.beginPath(); ctx.rect(shapeStartX, shapeStartY, x-shapeStartX, y-shapeStartY); ctx.stroke();
            } else if (currentTool === 'circle') {
                const rectX = Math.min(shapeStartX, x);
                const rectY = Math.min(shapeStartY, y);
                const width = Math.abs(x - shapeStartX);
                const height = Math.abs(y - shapeStartY);
                const centerX = rectX + width / 2;
                const centerY = rectY + height / 2;
                const radius = Math.min(width, height) / 2;

                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();

            }
        });

        canvasEl.addEventListener('mouseleave', () => {
            if (isPenDrawing) isPenDrawing = false;
        });

        // Touch support for telestration
        canvasEl.addEventListener('touchstart', e => {
            if (!canvasEl.classList.contains('active-drawing')) return;
            const touch = e.touches[0];
            const rect = canvasEl.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            if (currentTool === 'pen') {
                isPenDrawing = true;
                penInitialX = penLastX = x;
                penInitialY = penLastY = y;
                ctx.beginPath(); ctx.moveTo(penLastX, penLastY);
            } else {
                shapeStartX = x; shapeStartY = y;
            }
        });

        canvasEl.addEventListener('touchmove', e => {
            if (!canvasEl.classList.contains('active-drawing')) return;
            e.preventDefault(); // Prevent scrolling while drawing
            const touch = e.touches[0];
            const rect = canvasEl.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            if (currentTool === 'pen' && isPenDrawing) {
                const midX = (penLastX + x) / 2;
                const midY = (penLastY + y) / 2;
                ctx.quadraticCurveTo(penLastX, penLastY, midX, midY);
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = lineWidth;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                penLastX = x; penLastY = y;
                ctx.beginPath(); ctx.moveTo(midX, midY);
            }
        }, { passive: false });

        canvasEl.addEventListener('touchend', e => {
            if (!canvasEl.classList.contains('active-drawing')) return;
            const touch = e.changedTouches[0];
            const rect = canvasEl.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            if (currentTool === 'pen') {
                if (!isPenDrawing) return;
                isPenDrawing = false;
                if (penInitialX === x && penInitialY === y) {
                    ctx.fillStyle = strokeColor;
                    ctx.beginPath();
                    ctx.arc(penInitialX, penInitialY, lineWidth/2, 0, 2*Math.PI);
                    ctx.fill();
                } else {
                    ctx.lineTo(x, y); ctx.stroke();
                }
            } else if (currentTool === 'line') {
                ctx.beginPath(); ctx.moveTo(shapeStartX, shapeStartY);
                ctx.lineTo(x, y); ctx.stroke();
            } else if (currentTool === 'arrow') {
                drawArrow(shapeStartX, shapeStartY, x, y);
            } else if (currentTool === 'rectangle') {
                ctx.beginPath(); ctx.rect(shapeStartX, shapeStartY, x-shapeStartX, y-shapeStartY); ctx.stroke();
            } else if (currentTool === 'circle') {
                const rectX = Math.min(shapeStartX, x);
                const rectY = Math.min(shapeStartY, y);
                const width = Math.abs(x - shapeStartX);
                const height = Math.abs(y - shapeStartY);
                const centerX = rectX + width / 2;
                const centerY = rectY + height / 2;
                const radius = Math.min(width, height) / 2;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
            }
        });


        function drawArrow(fromX, fromY, toX, toY) {
            const headlen = 10 + lineWidth*2;
            const dx = toX - fromX, dy = toY - fromY;
            const angle = Math.atan2(dy, dx);
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.lineTo(toX - headlen*Math.cos(angle - Math.PI/6), toY - headlen*Math.sin(angle - Math.PI/6));
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headlen*Math.cos(angle + Math.PI/6), toY - headlen*Math.sin(angle + Math.PI/6));
            ctx.stroke();
        }

        // Activate pen tool by default
        penToolBtnEl.click();
    </script>
</body>
</html>
